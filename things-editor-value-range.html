<link rel="import" href="../polymer/polymer.html">

<!--
An element providing a solution to no problem in particular.

Example:

  <things-editor-value-range range="{{rule.range}}"
                             key-type="[[type]]"
                             value-type="[[valueType]]">
  </things-editor-value-range>

@demo demo/index-editor-value-range-color.html
@demo demo/index-editor-value-range.html
@hero hero.svg
-->

<dom-module id="things-editor-value-range">
  <template>
    <style>
      :host {
        @apply(--things-variable-ruletype-container)
      }
      *{float:left;}
      input{
        width:20%;
        margin:3px 0 3px 3px;
      }
      input[type='color']{
        @apply(--things-input-color);
        height:15px;
        top:2px;
      }
      input[type='color']::-webkit-color-swatch-wrapper{padding:0;}
      input[type='color']::-webkit-color-swatch{border:0;}
      div input[data-value-type='color']:nth-child(3){width:38.5%;}
      div input.default-value[data-value-type='color']{width:62%;}
      div{border-bottom:1px solid #c0c0c0;}
      div:last-child{border-bottom:none;}
      .record-action{
        @apply(--things-record-action-button);
      }
    </style>

    <template is="dom-repeat" items="{{_toArray(range)}}">
      <div data-record>
        <input type="text" data-from placeholder="from" value="{{item.from}}"/>
        <input type="text" data-to placeholder="to" value="{{item.to}}"/>
        <template is="dom-if" if="[[_isBooleanType(valueType)]]">
          <input type="checkbox" data-value checked="{{item.value::change}}" data-value-type$="[[valueType]]"/>
        </template>
        <template is="dom-if" if="[[!_isBooleanType(valueType)]]">
          <input type="text" data-value placeholder="value" value="{{item.value}}" data-value-type$="[[valueType]]"/>
        </template>
        <template is="dom-if" if="[[_isColorType(valueType)]]">
          <input data-value type="color" value="{{item.value}}" tabindex="-1"/>
        </template>
        <button class="record-action" on-tap="_delete" tabindex="-1">-</button>
      </div>
    </template>

    <div data-record-new>
      <input type="text" data-from placeholder="from" value=""/>
      <input type="text" data-to placeholder="to" value=""/>
      <template is="dom-if" if="[[_isBooleanType(valueType)]]">
        <input type="checkbox" data-value data-value-type$="[[valueType]]"/>
      </template>
      <template is="dom-if" if="[[!_isBooleanType(valueType)]]">
        <input type="text" data-value placeholder="value" value="" data-value-type$="[[valueType]]"/>
      </template>
      <template is="dom-if" if="[[_isColorType(valueType)]]">
        <input data-value type="color" tabindex="-1"/>
      </template>
      <button class="record-action" on-tap="_add" tabindex="-1">+</button>
    </div>

    <div data-record>
      <input type="text" data-from data-default disabled value="default"/>
      <input type="text" data-to placeholder="to" value="" hidden/>
      <template is="dom-if" if="[[_isBooleanType(valueType)]]">
        <input type="checkbox" data-value checked="{{range.default::change}}" class="default-value" data-value-type$="[[valueType]]"/>
      </template>
      <template is="dom-if" if="[[!_isBooleanType(valueType)]]">
        <input type="text" data-value value="{{range.default}}" placeholder="value" class="default-value" data-value-type$="[[valueType]]"/>
      </template>
      <template is="dom-if" if="[[_isColorType(valueType)]]">
        <input data-value type="color" value="{{range.default}}" tabindex="-1"/>
      </template>
      <button class="record-action" on-tap="_sort">&gt;</button>
    </div>

  </template>

  <script>

    Polymer({
      is: 'things-editor-value-range',

      properties: {
        range: {
          type: Object,
          notify: true,
          value: {}
        },
        rangeType: {
          notify: true,
          value: 'number'
        },
        valueType: {
          notify: true,
          value: 'string'
        }
      },

      listeners: {
        'change': '_onChange'
      },

      _isColorType: function(type) {
        return type === 'color'
      },

      _isBooleanType: function(type) {
        return type === 'boolean'
      },

      _onChange: function(e) {

        var input = e.target
        var value

        if(input.type == 'checkbox')
          value = Boolean(input.checked)
        else
          value = input.value

        var div = input.parentElement

        if(input.hasAttribute('data-value')) {
          var dataList = div.querySelectorAll('[data-value]:not([hidden])')
          for(var i = 0;i < dataList.length;i++)
            if(dataList[i] !== input)
              dataList[i].value = value
        }

        if(div.hasAttribute('data-record'))
          this._build()
        else if(div.hasAttribute('data-record-new') && input.hasAttribute('data-value'))
          this._add()

        e.stopPropagation()
      },

      _build: function(includeNewRecord) {
        if(includeNewRecord)
          var records = this.querySelectorAll('[data-record],[data-record-new]')
        else
          var records = this.querySelectorAll('[data-record]')

        var newrange = {}

        for(var i = 0;i < records.length;i++) {
          var record = records[i]

          var from = record.querySelector('[data-from]').value
          var to = record.querySelector('[data-to]').value
          var input = record.querySelector('[data-value]:not([hidden])')
          var value

          if(input.type == 'checkbox')
            value = Boolean(input.checked)
          else
            value = input.value

          if(from) {
            if(from === 'default')
              newrange['default'] = value || (this.valueType == 'color' ? '#000000': '')
            else
              newrange[`${from}~${to}`] = value
          }
        }

        this.set('range', newrange)
      },

      /* default를 제외한 range아이템들을 template(dom-repeat)용 배열로 변환하는 함수 */
      _toArray: function(range) {
        var array = []

        for(var key in range) {
          if(key == 'default')
            continue

          var fromto = key.split('~')

          array.push({
            from: fromto[0],
            to: fromto[1],
            value: range[key]
          })
        }

        return array
      },

      _sort: function(e) {

        var sorter = this.rangeType === 'number' ?
          function(a, b) {
            return parseFloat(b.from) < parseFloat(a.from)
          } :
          function(a, b) {
            return b.from < a.from
          }

        var range = this._toArray(this.range).sort(sorter).reduce(function(sum, i) {
          sum[`${i.from}~${i.to}`] = i.value
          return sum
        }, {})

        range.default = this.range.default

        this.set('range', range)
      },

      _add: function(e) {
        this._build(true)

        var inputs = this.querySelectorAll('[data-record-new] input')

        for (var i = 0;i < inputs.length;i++) {
          let input = inputs[i]
          input.value = (input.type == 'color') ? '#000000' : ''
        }

        inputs[0].focus()
      },

      _delete: function(e) {
        var record = e.target.parentElement
        record.querySelector('[data-from]').value = ''
        this._build()
      }

    });

  </script>
</dom-module>
