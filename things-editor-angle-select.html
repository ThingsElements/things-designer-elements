<link rel="import" href="../polymer/polymer.html">

<!--
Degree 각도 값을 입력 받아서, radian 값으로 변환해주는 select의 확장 엘리먼트이다.

Example:

  <things-editor-angle-select radian="{{radian}}">
    <select is="things-editor-angle-select">
      <option value="0">0˚</option>
      <option value="90">90˚</option>
      <option value="180">180˚</option>
      <option value="270">270˚</option>
    <select>
  </things-editor-angle-select>

@demo demo/index-editor-angle-select.html
@hero hero.svg
-->

<dom-module id="things-editor-angle-select">
  <template>
    <style>
      :host {
        display: inline-block;
      }
    </style>
    <slot id="content"></slot>
  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'things-editor-angle-select',

      properties: {
        /**
         * `radian`은 각도의 ragian값이다.
         */
        radian: {
          type: Number,
          notify: true
        }
      },

      listeners: {
        'change': "_onChangeValue"
      },

      observers: [
        "_onChangeRadian(radian)"
      ],

      created() {
        if(!this.getAttribute('placeholder'))
          this.setAttribute('placeholder', '°')
      },

      attached() {
        this._observer = Polymer.dom(this).observeNodes(function(info) {
          this._initSlottedSelect();
        }.bind(this));
      },
      
      detached() {
        if (this._observer) {
          Polymer.dom(this).unobserveNodes(this._observer);
          this._observer = null;
        }
      },

      /**
       * Returns the distributed <select> element.
       */
      get selectElement () {
        return this._selectElement;
      },

      _initSlottedSelect: function() {
        this._selectElement = this.getEffectiveChildren()[0];
        if(!this._selectElement)
          return;

        this._onChangeRadian(this.radian);
      },

      _onChangeValue(e) {
        var degree = this.selectElement.value;

        if(isNaN(degree))
          this.set('radian', undefined);
        else
          this.set('radian', degree * (Math.PI / 180));
      },

      _onChangeRadian(radian) {
        var PI_2 = Math.PI * 2
        var value = (((radian % PI_2) + PI_2) % PI_2) * 180 / Math.PI

        var nearest_option = -1
        var diff

        Array.from(this.selectElement.options).forEach(function(option, index) {
          let gap = Math.abs(Number(value) - Number(option.value)) % 360
          if(gap > 180)
            gap = 360 - gap

          if(nearest_option == -1) {
            nearest_option = index
            diff = gap
            return
          }

          if(diff > gap) {
            nearest_option = index
            diff = gap
          }
        })

        this.selectElement.selectedIndex = nearest_option;
      }
    });
  })();
  </script>
</dom-module>
